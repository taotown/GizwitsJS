/**
 * @fileOverview  Gizwits JavaScript SDK
 * @version 0.1.0
 * @author Trevor(trevortao@gizwits.com)
 */
function GizwitsJS(e){return e?e.apiHost?e.gizwitsOpenId?e.gizwitsAppId?(this.onBindDevice=void 0,this.onEventNotify=void 0,this.onReceiveData=void 0,this.onUnBindDevice=void 0,this.onSetDeviceInfo=void 0,this.onGetDeviceList=void 0,this.onDiscoverDevices=void 0,this.onSubscribeDevice=void 0,this.onUpdateSubDevices=void 0,this.onDeviceOnlineStatusChanged=void 0,this._gloabSN=1,this._keepalive=180,this._subDevices={},this._connections={},this._boundDevices={},this._userID=void 0,this._userToken=void 0,this._heartbeatInterval=55,this._apiHost=e.apiHost,this._appID=e.gizwitsAppId,void(this._openID=e.gizwitsOpenId)):void console.log("Call GizwitsJS with invaild params.gizwitsAppId "+e.gizwitsAppId):void console.log("Call GizwitsJS with invaild params.gizwitsOpenId "+e.gizwitsOpenId):void console.log("Call GizwitsJS with invaild params.apiHost "+e.apiHost):void console.log("Call GizwitsJS with invaild params "+e)}function Connection(e,i){this._subscribedDids={},this._loginFailedCount=0,this._websocket=void 0,this._callbackObj=i,this._heartbeatTimerID=void 0,this._lastConnectMilliTimestamp=0,this._wsUrl="{0}/ws/app/v1".format(e)}function hexMD5(e){return binl2hex(coreMD5(str2binl(e),e.length*CHAR_SIZE))}function coreMD5(e,i){e[i>>5]|=128<<i%32,e[14+(i+64>>>9<<4)]=i
for(var t=1732584193,n=-271733879,s=-1732584194,d=271733878,o=0;o<e.length;o+=16){var r=t,_=n,a=s,c=d
t=md5FF(t,n,s,d,e[o+0],7,-680876936),d=md5FF(d,t,n,s,e[o+1],12,-389564586),s=md5FF(s,d,t,n,e[o+2],17,606105819),n=md5FF(n,s,d,t,e[o+3],22,-1044525330),t=md5FF(t,n,s,d,e[o+4],7,-176418897),d=md5FF(d,t,n,s,e[o+5],12,1200080426),s=md5FF(s,d,t,n,e[o+6],17,-1473231341),n=md5FF(n,s,d,t,e[o+7],22,-45705983),t=md5FF(t,n,s,d,e[o+8],7,1770035416),d=md5FF(d,t,n,s,e[o+9],12,-1958414417),s=md5FF(s,d,t,n,e[o+10],17,-42063),n=md5FF(n,s,d,t,e[o+11],22,-1990404162),t=md5FF(t,n,s,d,e[o+12],7,1804603682),d=md5FF(d,t,n,s,e[o+13],12,-40341101),s=md5FF(s,d,t,n,e[o+14],17,-1502002290),n=md5FF(n,s,d,t,e[o+15],22,1236535329),t=md5GG(t,n,s,d,e[o+1],5,-165796510),d=md5GG(d,t,n,s,e[o+6],9,-1069501632),s=md5GG(s,d,t,n,e[o+11],14,643717713),n=md5GG(n,s,d,t,e[o+0],20,-373897302),t=md5GG(t,n,s,d,e[o+5],5,-701558691),d=md5GG(d,t,n,s,e[o+10],9,38016083),s=md5GG(s,d,t,n,e[o+15],14,-660478335),n=md5GG(n,s,d,t,e[o+4],20,-405537848),t=md5GG(t,n,s,d,e[o+9],5,568446438),d=md5GG(d,t,n,s,e[o+14],9,-1019803690),s=md5GG(s,d,t,n,e[o+3],14,-187363961),n=md5GG(n,s,d,t,e[o+8],20,1163531501),t=md5GG(t,n,s,d,e[o+13],5,-1444681467),d=md5GG(d,t,n,s,e[o+2],9,-51403784),s=md5GG(s,d,t,n,e[o+7],14,1735328473),n=md5GG(n,s,d,t,e[o+12],20,-1926607734),t=md5HH(t,n,s,d,e[o+5],4,-378558),d=md5HH(d,t,n,s,e[o+8],11,-2022574463),s=md5HH(s,d,t,n,e[o+11],16,1839030562),n=md5HH(n,s,d,t,e[o+14],23,-35309556),t=md5HH(t,n,s,d,e[o+1],4,-1530992060),d=md5HH(d,t,n,s,e[o+4],11,1272893353),s=md5HH(s,d,t,n,e[o+7],16,-155497632),n=md5HH(n,s,d,t,e[o+10],23,-1094730640),t=md5HH(t,n,s,d,e[o+13],4,681279174),d=md5HH(d,t,n,s,e[o+0],11,-358537222),s=md5HH(s,d,t,n,e[o+3],16,-722521979),n=md5HH(n,s,d,t,e[o+6],23,76029189),t=md5HH(t,n,s,d,e[o+9],4,-640364487),d=md5HH(d,t,n,s,e[o+12],11,-421815835),s=md5HH(s,d,t,n,e[o+15],16,530742520),n=md5HH(n,s,d,t,e[o+2],23,-995338651),t=md5II(t,n,s,d,e[o+0],6,-198630844),d=md5II(d,t,n,s,e[o+7],10,1126891415),s=md5II(s,d,t,n,e[o+14],15,-1416354905),n=md5II(n,s,d,t,e[o+5],21,-57434055),t=md5II(t,n,s,d,e[o+12],6,1700485571),d=md5II(d,t,n,s,e[o+3],10,-1894986606),s=md5II(s,d,t,n,e[o+10],15,-1051523),n=md5II(n,s,d,t,e[o+1],21,-2054922799),t=md5II(t,n,s,d,e[o+8],6,1873313359),d=md5II(d,t,n,s,e[o+15],10,-30611744),s=md5II(s,d,t,n,e[o+6],15,-1560198380),n=md5II(n,s,d,t,e[o+13],21,1309151649),t=md5II(t,n,s,d,e[o+4],6,-145523070),d=md5II(d,t,n,s,e[o+11],10,-1120210379),s=md5II(s,d,t,n,e[o+2],15,718787259),n=md5II(n,s,d,t,e[o+9],21,-343485551),t=safeAdd(t,r),n=safeAdd(n,_),s=safeAdd(s,a),d=safeAdd(d,c)}return Array(t,n,s,d)}function md5CMN(e,i,t,n,s,d){return safeAdd(bitRol(safeAdd(safeAdd(i,e),safeAdd(n,d)),s),t)}function md5FF(e,i,t,n,s,d,o){return md5CMN(i&t|~i&n,e,i,s,d,o)}function md5GG(e,i,t,n,s,d,o){return md5CMN(i&n|t&~n,e,i,s,d,o)}function md5HH(e,i,t,n,s,d,o){return md5CMN(i^t^n,e,i,s,d,o)}function md5II(e,i,t,n,s,d,o){return md5CMN(t^(i|~n),e,i,s,d,o)}function safeAdd(e,i){var t=(65535&e)+(65535&i)
return(e>>16)+(i>>16)+(t>>16)<<16|65535&t}function bitRol(e,i){return e<<i|e>>>32-i}function str2binl(e){for(var i=Array(),t=(1<<CHAR_SIZE)-1,n=0;n<e.length*CHAR_SIZE;n+=CHAR_SIZE)i[n>>5]|=(e.charCodeAt(n/CHAR_SIZE)&t)<<n%32
return i}function binl2hex(e){for(var i="",t="0123456789abcdef",n=0;n<4*e.length;n++)i+=t.charAt(e[n>>2]>>n%4*8+4&15)+t.charAt(e[n>>2]>>n%4*8&15)
return i}var LEN_DID=22,CHAR_SIZE=8,LEN_PRODUCT_KEY=32,P0_TYPE_ATTRS_V4="attrs_v4",PROTOCOL_VER=[0,0,0,3],RETRY_WAIT_TIME=5e3,RETRY_SEND_TIME=2e3,GET_BOUND_DEV_ONE_STEP_LIMIT=20,DEV_TYPE_NORMAL="normal",DEV_TYPE_CENTER_CONTROL="center_control",DEV_TYPE_SUB="sub_dev",CMD_TRANS_BUSINESS_RESP=148,P0_CMD_REPORT_SUBDEVICE_STATUS=16,P0_CMD_ADD_SUBDEVICE_RESP=87,P0_CMD_DELETE_SUBDEVICE_RESP=89,P0_CMD_GET_SUBDEVICE_LIST_RESP=91,P0_CMD_REPORT_SUBDEVICE_LIST=92,ERROR_CODE={GIZ_SDK_PARAM_INVALID:8006,GIZ_SDK_DEVICE_DID_INVALID:8024,GIZ_SDK_DEVICE_NOT_CENTERCONTROL:8028,GIZ_SDK_BIND_DEVICE_FAILED:8039,GIZ_SDK_UNBIND_DEVICE_FAILED:8040,GIZ_SDK_HTTP_REQUEST_FAILED:8099,GIZ_SDK_WEB_SOCKET_CLOSED:8900,GIZ_SDK_SUBSCRIBE_FAILED:8901,GIZ_SDK_WEB_SOCKET_INVALID:8902,GIZ_SDK_WEB_SOCKET_ERROR:8903,GIZ_SDK_SET_DEVICE_INFO_ERROR:8904}
GizwitsJS.prototype.discoverDevices=function(){this._getUserToken()},GizwitsJS.prototype.getDeviceList=function(){this._onDiscoverDevices(this.onGetDeviceList)},GizwitsJS.prototype.subscribeDevice=function(e){if(!e)return void this._sendError(this.onSubscribeDevice,ERROR_CODE.GIZ_SDK_PARAM_INVALID,"Invaild params "+e)
if(!e.did)return void this._sendError(this.onSubscribeDevice,ERROR_CODE.GIZ_SDK_PARAM_INVALID,"Invaild params.did "+e.did)
if(!this._boundDevices)return void this._sendError(this.onSubscribeDevice,GIZ_SDK_DEVICE_DID_INVALID,arguments.callee.name+"Invaild did",e.did)
var i=this._boundDevices[e.did]
if(!i)return void this._sendError(this.onSubscribeDevice,ERROR_CODE.GIZ_SDK_DEVICE_DID_INVALID,"Invaild did",e.did)
this._connect(i)},GizwitsJS.prototype.read=function(e){if(!e)return void this._sendError(this.onReceiveData,ERROR_CODE.GIZ_SDK_PARAM_INVALID,arguments.callee.name+": invaild params "+e)
if(!e.did)return void this._sendError(this.onReceiveData,ERROR_CODE.GIZ_SDK_PARAM_INVALID,arguments.callee.name+": invaild params.did "+e.did)
if(!this._boundDevices)return void this._sendError(this.onReceiveData,ERROR_CODE.GIZ_SDK_DEVICE_DID_INVALID,arguments.callee.name+": invaild did",e.did)
var i=this._boundDevices[e.did]
if(!i)return void this._sendError(this.onReceiveData,ERROR_CODE.GIZ_SDK_DEVICE_DID_INVALID,arguments.callee.name+": invaild did",e.did)
e.attrs?this._sendJson(i,{cmd:"c2s_read",data:{did:e.did,names:e.attrs}}):this._sendJson(i,{cmd:"c2s_read",data:{did:e.did}})},GizwitsJS.prototype.write=function(e){if(!e)return void this._sendError(this.onReceiveData,ERROR_CODE.GIZ_SDK_PARAM_INVALID,arguments.callee.name+": invaild params "+e)
if(!e.did)return void this._sendError(this.onReceiveData,ERROR_CODE.GIZ_SDK_PARAM_INVALID,arguments.callee.name+": invaild params.did "+e.did)
if(!this._boundDevices)return void this._sendError(this.onReceiveData,ERROR_CODE.GIZ_SDK_DEVICE_DID_INVALID,arguments.callee.name+": invaild did",e.did)
var i=this._boundDevices[e.did]
if(!i)return void this._sendError(this.onReceiveData,ERROR_CODE.GIZ_SDK_DEVICE_DID_INVALID,arguments.callee.name+": invaild did",e.did)
e.attrs&&this._sendJson(i,{cmd:"c2s_write",data:{did:e.did,attrs:e.attrs}}),e.raw&&this._sendJson(i,{cmd:"c2s_raw",data:{did:e.did,raw:e.raw}})},GizwitsJS.prototype.updateSubDevices=function(e){if(!e)return void this._sendError(this.onUpdateSubDevices,ERROR_CODE.GIZ_SDK_PARAM_INVALID,arguments.callee.name+": invaild params "+e)
if(!e.did)return void this._sendError(this.onUpdateSubDevices,ERROR_CODE.GIZ_SDK_PARAM_INVALID,arguments.callee.name+": invaild params.did "+e.did)
if(this._boundDevices,!1)return void this._sendError(this.onUpdateSubDevices,ERROR_CODE.GIZ_SDK_DEVICE_DID_INVALID,arguments.callee.name+": invaild did",e.did)
var i=this._boundDevices[e.did]
if(!i)return void this._sendError(this.onUpdateSubDevices,ERROR_CODE.GIZ_SDK_DEVICE_DID_INVALID,arguments.callee.name+": invaild did",e.did)
if(i.type!=DEV_TYPE_CENTER_CONTROL)return void this._sendError(this.onUpdateSubDevices,ERROR_CODE.GIZ_SDK_DEVICE_NOT_CENTERCONTROL,arguments.callee.name+": is not center control device",e.did)
var t=0,n=new Uint8Array(8),s=new DataView(n.buffer)
n[t++]=0,n.set([0,147],t),t+=2,s.setInt32(t,this._gloabSN++),t+=4,n[t++]=90
var d=PROTOCOL_VER.concat(this._getMQTTLenArray(t)).concat(Array.from(n.slice(0,t)))
this._sendJson(i,{cmd:"c2s_raw",data:{did:e.did,raw:d}})},GizwitsJS.prototype.addSubDevice=function(e){if(!e)return void this._sendError(this.onUpdateSubDevices,ERROR_CODE.GIZ_SDK_PARAM_INVALID,arguments.callee.name+": invaild params "+e)
if(!e.did)return void this._sendError(this.onUpdateSubDevices,ERROR_CODE.GIZ_SDK_PARAM_INVALID,arguments.callee.name+": invaild params.did "+e.did)
if(!this._boundDevices)return void this._sendError(this.onUpdateSubDevices,ERROR_CODE.GIZ_SDK_DEVICE_DID_INVALID,arguments.callee.name+": invaild did",e.did)
var i=this._boundDevices[e.did]
if(!i)return void this._sendError(this.onUpdateSubDevices,ERROR_CODE.GIZ_SDK_DEVICE_DID_INVALID,arguments.callee.name+": invaild did",e.did)
if(i.type!=DEV_TYPE_CENTER_CONTROL)return void this._sendError(this.onUpdateSubDevices,ERROR_CODE.GIZ_SDK_DEVICE_NOT_CENTERCONTROL,arguments.callee.name+": is not center control device",e.did)
var t=0,n=new Uint8Array(128),s=new DataView(n.buffer)
n[t++]=0,n.set([0,147],t),t+=2,s.setInt32(t,this._gloabSN++),t+=4,n[t++]=86
var d=e.subDevices?e.subDevices.length:0
s.setInt16(t,d),t+=2
for(var o=new TextEncoder,r=0;r<d;r++){var _=e.subDevices[r].mac
_&&(n[t++]=_.length,n.set(o.encode(_),t),t+=_.length)}var a=PROTOCOL_VER.concat(this._getMQTTLenArray(t)).concat(Array.from(n.slice(0,t)))
this._sendJson(i,{cmd:"c2s_raw",data:{did:e.did,raw:a}})},GizwitsJS.prototype.removeSubDevice=function(e){if(!e)return void this._sendError(this.onUpdateSubDevices,ERROR_CODE.GIZ_SDK_PARAM_INVALID,arguments.callee.name+": invaild params "+e)
if(!e.did)return void this._sendError(this.onUpdateSubDevices,ERROR_CODE.GIZ_SDK_PARAM_INVALID,arguments.callee.name+": invaild params.did "+e.did)
if(!e.subDevices)return void this._sendError(this.onUpdateSubDevices,ERROR_CODE.GIZ_SDK_PARAM_INVALID,arguments.callee.name+": invaild params.subDevices "+e.subDevices,e.did)
if(!this._boundDevices)return void this._sendError(this.onUpdateSubDevices,ERROR_CODE.GIZ_SDK_DEVICE_DID_INVALID,arguments.callee.name+": invaild did",e.did)
var i=this._boundDevices[e.did]
if(!i)return void this._sendError(this.onUpdateSubDevices,ERROR_CODE.GIZ_SDK_DEVICE_DID_INVALID,arguments.callee.name+": invaild did",e.did)
if(i.type!=DEV_TYPE_CENTER_CONTROL)return void this._sendError(this.onUpdateSubDevices,ERROR_CODE.GIZ_SDK_DEVICE_NOT_CENTERCONTROL,arguments.callee.name+": is not center control device",e.did)
var t=this._subDevices[e.did]
if(!t)return void this._sendError(this.onUpdateSubDevices,ERROR_CODE.GIZ_SDK_DEVICE_DID_INVALID,arguments.callee.name+": invaild did",e.did)
for(var n=0;n<e.subDevices.length;n++){var s=t[e.subDevices[n].did]
if(s){var d=0,o=new Uint8Array(16),r=new DataView(o.buffer)
o[d++]=0,o.set([0,147],d),d+=2,r.setInt32(d,this._gloabSN++),d+=4,o[d++]=88,r.setInt32(d,s.subDid),d+=4
var _=PROTOCOL_VER.concat(this._getMQTTLenArray(d)).concat(Array.from(o.slice(0,d)))
this._sendJson(i,{cmd:"c2s_raw",data:{did:e.did,raw:_}})}}},GizwitsJS.prototype.bindDevice=function(e){return e?e.device?e.bindInfo?void(e.bindInfo.product_secret?this._bindDeviceByMAC(e.device.mac,e.device.productKey,e.bindInfo.product_secret):e.bindInfo.device_bind_url?this._bindDeviceCustom(e.device.mac,e.device.productKey,e.bindInfo.device_bind_url):this._sendError(this.onBindDevice,ERROR_CODE.GIZ_SDK_PARAM_INVALID,"Please special valid product_secret or device_bind_url in bindInfo when calling bindDevice.")):void this._sendError(this.onBindDevice,ERROR_CODE.GIZ_SDK_PARAM_INVALID,"Invaild params.bindInfo "+e.bindInfo):void this._sendError(this.onBindDevice,ERROR_CODE.GIZ_SDK_PARAM_INVALID,"Invaild params.device "+e.device):void this._sendError(this.onBindDevice,ERROR_CODE.GIZ_SDK_PARAM_INVALID,"Invaild params "+e)},GizwitsJS.prototype.unBindDevice=function(e){if(!e)return void this._sendError(this.onUnBindDevice,ERROR_CODE.GIZ_SDK_PARAM_INVALID,"Invaild params "+e)
if(!e.did)return void this._sendError(this.onUnBindDevice,ERROR_CODE.GIZ_SDK_PARAM_INVALID,"Invaild params.did "+e.did)
if(!this._boundDevices)return void this._sendError(this.onUnBindDevice,ERROR_CODE.GIZ_SDK_DEVICE_DID_INVALID,arguments.callee.name+": invaild did",e.did)
var i=this._boundDevices[e.did]
if(!i)return void this._sendError(this.onUnBindDevice,ERROR_CODE.GIZ_SDK_DEVICE_DID_INVALID,arguments.callee.name+": invaild did",e.did)
this._unBindDevice(i.did)},GizwitsJS.prototype.setDeviceInfo=function(e){return e?e.did?null==e.remark&&null==e.alias?void this._sendError(this.onSetDeviceInfo,ERROR_CODE.GIZ_SDK_PARAM_INVALID,"Invaild params.remark "+e.remark+" and params.alias "+e.alias):this._boundDevices[e.did]?void this._setDeviceInfo(e.did,e.alias,e.remark):void this._sendError(this.onSetDeviceInfo,ERROR_CODE.GIZ_SDK_DEVICE_DID_INVALID,arguments.callee.name+": invaild did",e.did):void this._sendError(this.onSetDeviceInfo,ERROR_CODE.GIZ_SDK_PARAM_INVALID,"Invaild params.did "+e.did):void this._sendError(this.onSetDeviceInfo,ERROR_CODE.GIZ_SDK_PARAM_INVALID,"Invaild params "+e)},GizwitsJS.prototype._unBindDevice=function(e){var i=this,t="https://{0}/app/bindings".format(i._apiHost),n=JSON.stringify({devices:[{did:e}]})
$.ajax(t,{type:"DELETE",contentType:"application/json",headers:{"X-Gizwits-Application-Id":i._appID,"X-Gizwits-User-token":i._userToken},dataType:"json",data:n}).done(function(t){t.success&&t.success[0]?(i.onUnBindDevice({did:e}),DEV_TYPE_CENTER_CONTROL===i._boundDevices[e].type&&delete i.subDevices[e],delete i._boundDevices[e],i._onDiscoverDevices(i.onDiscoverDevices)):i._sendError(i.onUnBindDevice,ERROR_CODE.GIZ_SDK_UNBIND_DEVICE_FAILED,"unbindDevice failed: "+JSON.stringify(t))}).fail(function(t){i._sendError(i.onUnBindDevice,ERROR_CODE.GIZ_SDK_UNBIND_DEVICE_FAILED,"unbind device error, status:"+t.status+", responseText:"+t.responseText,e)})},GizwitsJS.prototype._setDeviceInfo=function(e,i,t){var n=this,s=!1,d="https://{0}/app/bindings/".format(n._apiHost)+e,o={}
t&&(o.remark=t),i&&(o.dev_alias=i)
var r=JSON.stringify(o)
$.ajax(d,{type:"PUT",contentType:"application/json",headers:{"X-Gizwits-Application-Id":n._appID,"X-Gizwits-User-token":n._userToken},dataType:"json",data:r}).done(function(i){i.remark&&n._boundDevices[e].remark!=i.remark&&(n._boundDevices[e].remark=i.remark,s=!0),i.dev_alias&&n._boundDevices[e].dev_alias!=i.dev_alias&&(n._boundDevices[e].dev_alias=i.dev_alias,s=!0),n.onSetDeviceInfo&&n.onSetDeviceInfo({did:e}),s&&n._onDiscoverDevices(n.onDiscoverDevices)}).fail(function(i){n._sendError(n.onSetDeviceInfo,ERROR_CODE.GIZ_SDK_SET_DEVICE_INFO_ERROR,"set device info error, status:"+i.status+", responseText:"+i.responseText,e)})},GizwitsJS.prototype._bindDeviceByMAC=function(e,i,t){var n=this,s=Date.now()/1e3>>0,d=hexMD5(t+s),o="https://{0}/app/bind_mac".format(n._apiHost),r=JSON.stringify({mac:e,product_key:i})
$.ajax(o,{type:"POST",contentType:"application/json",headers:{"X-Gizwits-Application-Id":n._appID,"X-Gizwits-User-token":n._userToken,"X-Gizwits-Timestamp":s,"X-Gizwits-Signature":d},dataType:"json",data:r}).done(function(e){e.did?(n._boundDevices[e.did]=e,n.onBindDevice&&n.onBindDevice({did:e.did}),n._onDiscoverDevices(n.onDiscoverDevices)):n._sendError(n.onBindDevice,ERROR_CODE.GIZ_SDK_BIND_DEVICE_FAILED,"bindDevice response invaild result: "+JSON.stringify(e))}).fail(function(e){n._sendError(n.onBindDevice,ERROR_CODE.GIZ_SDK_BIND_DEVICE_FAILED,"bindDevice error, status:"+e.status+", responseText:"+e.responseText)})},GizwitsJS.prototype._bindDeviceCustom=function(e,i,t){var n=this,s=JSON.stringify({mac:e,token:n._userToken,product_key:i})
$.ajax(t,{type:"POST",contentType:"application/json",dataType:"json",data:s}).done(function(e){if(e.host)n._boundDevices[e.did]=e,n.onBindDevice&&n.onBindDevice({did:e.did}),n._onDiscoverDevices(n.onDiscoverDevices)
else{var i=!1
"online"===e.netStatus&&(i=!0),e.did?(n._boundDevices[e.did]={remark:"",dev_alias:"",type:"sub_dev",did:e.did,mac:e.mac,is_online:i,product_key:e.product_key},n.onBindDevice&&n.onBindDevice({did:e.did}),n._getBoundDevices(GET_BOUND_DEV_ONE_STEP_LIMIT,0)):n._sendError(n.onBindDevice,ERROR_CODE.GIZ_SDK_BIND_DEVICE_FAILED,"bindDevice response invaild result: "+JSON.stringify(e))}}).fail(function(e){n._sendError(n.onBindDevice,ERROR_CODE.GIZ_SDK_BIND_DEVICE_FAILED,"bindDevice error, status:"+e.status+", responseText:"+e.responseText)})},GizwitsJS.prototype._getUserToken=function(){var e=this,i="https://{0}/app/users".format(e._apiHost),t=JSON.stringify({phone_id:e._openID,lang:"en"})
$.ajax(i,{type:"POST",contentType:"application/json",headers:{"X-Gizwits-Application-Id":e._appID},dataType:"json",data:t}).done(function(i){e._userID=i.uid,e._userToken=i.token,e._getBoundDevices(GET_BOUND_DEV_ONE_STEP_LIMIT,0)}).fail(function(i){e._sendError(e.onDiscoverDevices,ERROR_CODE.GIZ_SDK_HTTP_REQUEST_FAILED,"get user token failed, status:"+i.status+", responseText:"+i.responseText)})},GizwitsJS.prototype._getBoundDevices=function(e,i){var t=this,n="https://{0}/app/bindings".format(t._apiHost),s="?show_disabled=0&limit="+e+"&skip="+i
$.ajax(n+s,{type:"GET",contentType:"application/json",dataType:"json",headers:{"X-Gizwits-Application-Id":t._appID,"X-Gizwits-User-token":t._userToken}}).done(function(n){t._boundDevices={}
for(var s=n.devices.length-1;s>=0;s--){var d=n.devices[s]
t._boundDevices[d.did]=d}n.devices.length===e?t._getBoundDevices(e,i+e):t._onDiscoverDevices(t.onDiscoverDevices)}).fail(function(e){t._boundDevices={},t._sendError(t.onDiscoverDevices,ERROR_CODE.GIZ_SDK_HTTP_REQUEST_FAILED,"getBoundDevices error, status:"+e.status+", responseText:"+e.responseText)})},Connection.prototype._connectWS=function(){var e=this
e._stopPing()
var i=new WebSocket(e._wsUrl)
i.onopen=function(i){e._onWSOpen(i)},i.onclose=function(i){e._onWSClose(i)},i.onmessage=function(i){e._onWSMessage(i)},i.onerror=function(i){e._onWSError(i)},e._websocket=i},Connection.prototype._onWSOpen=function(e){this._login()},Connection.prototype._onWSClose=function(e){this._stopPing(),this._callbackObj._sendError(null,ERROR_CODE.GIZ_SDK_WEB_SOCKET_CLOSED,"Websocket Connect failed, please try again after a moment.")},Connection.prototype._onWSMessage=function(e){var i=JSON.parse(e.data)
switch(i.cmd){case"pong":break
case"login_res":!0===i.data.success?(this._loginFailedCount=0,this._startPing(),this._subscribeDevices()):this._tryLoginAgain()
break
case"subscribe_res":var t=i.data.failed,n=i.data.success
if(this._callbackObj.onSubscribeDevice)for(var s=n.length-1;s>=0;s--)this._callbackObj.onSubscribeDevice({did:n[s].did})
for(var d=t.length-1;d>=0;d--)this._removeSubscribeDid(t[d].did),this._callbackObj._sendError(this._callbackObj.onSubscribeDevice,ERROR_CODE.GIZ_SDK_SUBSCRIBE_FAILED,"subscribe device failed, please try again.",t[d].did)
break
case"s2c_online_status":var o=this._callbackObj._boundDevices[i.data.did]
this._callbackObj.onDeviceOnlineStatusChanged&&o&&this._callbackObj.onDeviceOnlineStatusChanged({did:o.did,is_online:i.data.online})
break
case"s2c_raw":var r=void 0,_=[],a=i.data.did.substr(0,LEN_DID),o=this._callbackObj._boundDevices[a]
if(o){for(var c=0,s=4;s<i.data.raw.length&&128&i.data.raw[s];s++)++c
CMD_TRANS_BUSINESS_RESP===i.data.raw[7+c]?(r=i.data.raw[12+c],_=i.data.raw.slice(13+c)):(r=i.data.raw[8+c],_=i.data.raw.slice(9+c)),P0_CMD_REPORT_SUBDEVICE_STATUS===r?(this._callbackObj._processSubdeviceOnlineReport(a,_),this._callbackObj._onUpdateSubDevices(a)):P0_CMD_GET_SUBDEVICE_LIST_RESP===r||P0_CMD_REPORT_SUBDEVICE_LIST===r?this._callbackObj.onUpdateSubDevices&&(this._callbackObj._processSubdevicesReport(a,_),this._callbackObj._onUpdateSubDevices(a)):P0_CMD_ADD_SUBDEVICE_RESP===r?_[0]?console.log("center control device "+a+" add subDevice failed"):console.log("center control device "+a+" add subDevice success"):P0_CMD_DELETE_SUBDEVICE_RESP===r?_[0]?console.log("center control device "+a+" delete subDevice failed"):console.log("center control device "+a+" delete subDevice success"):this._callbackObj.onReceiveData&&this._callbackObj.onReceiveData({did:o.did,raw:i.data.raw})}break
case"s2c_noti":var o=this._callbackObj._boundDevices[i.data.did]
this._callbackObj.onReceiveData&&o&&this._callbackObj.onReceiveData({did:o.did,attrs:i.data.attrs})
break
case"s2c_invalid_msg":var D=i.data.error_code
1009===D?this._tryLoginAgain():this._callbackObj._sendError(null,ERROR_CODE.GIZ_SDK_WEB_SOCKET_INVALID,"ErrorCode "+D+": "+i.data.msg)}},Connection.prototype._onWSError=function(e){this._callbackObj._sendError(null,ERROR_CODE.GIZ_SDK_WEB_SOCKET_ERROR,"Websocket on error")},Connection.prototype._startPing=function(){var e=this
if(!e._heartbeatTimerID){var i=1e3*e._callbackObj._heartbeatInterval
e._heartbeatTimerID=window.setInterval(function(){e._sendJson({cmd:"ping"})},i)}},Connection.prototype._stopPing=function(){this._heartbeatTimerID&&(window.clearInterval(this._heartbeatTimerID),this._heartbeatTimerID=null)},Connection.prototype._sendJson=function(e){var i=JSON.stringify(e),t=this._websocket
return t.OPEN===t.readyState?(t.send(i),!0):(console.log("["+Date()+"]Send data "+i+" error, websocket is not connected."),this._callbackObj._sendError(null,ERROR_CODE.GIZ_SDK_WEB_SOCKET_INVALID,"Websocket is not connected, please try to subscribe device again"),this._stopPing(),!1)},Connection.prototype._login=function(){var e=this._callbackObj._keepalive,i={cmd:"login_req",data:{appid:this._callbackObj._appID,uid:this._callbackObj._userID,token:this._callbackObj._userToken,p0_type:P0_TYPE_ATTRS_V4,heartbeat_interval:e,auto_subscribe:!1}}
this._sendJson(i)},Connection.prototype._tryLoginAgain=function(){var e=this
if(e._loginFailedCount+=1,e._loginFailedCount>3)return void e._websocket.close()
var i=e._loginFailedCount*RETRY_WAIT_TIME
window.setTimeout(function(){e._login()},i)},Connection.prototype._addSubscribeDid=function(e){this._subscribedDids[e]=e},Connection.prototype._removeSubscribeDid=function(e){delete this._subscribedDids[e]},Connection.prototype._subscribeDevice=function(e){var i={cmd:"subscribe_req",data:[{did:e}]}
this._sendJson(i)},Connection.prototype._subscribeDevices=function(){var e=[]
for(var i in this._subscribedDids)e.push({did:this._subscribedDids[i]})
var t={cmd:"subscribe_req",data:e}
this._sendJson(t)},GizwitsJS.prototype._onDiscoverDevices=function(e){if(e){var i=0,t=[]
for(var n in this._boundDevices){var s=this._boundDevices[n],d=this._connections[this._getWebsocketConnInfo(s)],o=!!d&&!!d._subscribedDids[s.did]
t[i++]={is_bind:!0,did:s.did,mac:s.mac,remark:s.remark,alias:s.dev_alias,is_subscribe:o,is_online:s.is_online,product_key:s.product_key,type:this._getDevTypeByStr(s.type)}}for(var n in this._subDevices)for(var r in this._subDevices[n])if(!this._boundDevices[r]){var s=this._subDevices[n][r]
t[i++]={is_bind:!1,did:s.did,mac:s.mac,remark:"",alias:"",is_subscribe:!1,is_online:s.is_online,product_key:s.product_key,type:this._getDevTypeByStr(DEV_TYPE_SUB)}}e({devices:t},null)}},GizwitsJS.prototype._getDevTypeByStr=function(e){return DEV_TYPE_CENTER_CONTROL===e?1:DEV_TYPE_SUB===e?2:0},GizwitsJS.prototype._sendJson=function(e,i){var t=this._connections[this._getWebsocketConnInfo(e)]
if(!t)return void this._sendError(null,ERROR_CODE.GIZ_SDK_WEB_SOCKET_INVALID,"Websocket is not connected, please try to subscribe device again",e.did)
t._sendJson(i)||Date.now()-t._lastConnectMilliTimestamp>RETRY_WAIT_TIME&&(console.log("["+Date()+"]Send data error, try to connect again."),this._connect(e),t._lastConnectMilliTimestamp=Date.now(),window.setTimeout(function(){t._login()},RETRY_SEND_TIME))},GizwitsJS.prototype._connect=function(e){var i=this._getWebsocketConnInfo(e),t=this._connections[i]
t||(t=new Connection(i,this)),t._addSubscribeDid(e.did),t._websocket&&t._websocket.readyState==t._websocket.OPEN?t._subscribeDevice(e.did):(t._connectWS(),this._connections[i]=t)},GizwitsJS.prototype._sendError=function(e,i,t,n){e?n?e(null,{error_code:i,error_message:t,did:n}):e(null,{error_code:i,error_message:t}):this.onEventNotify&&(n?this.onEventNotify({event_id:i,event_content:{detail:t,did:n}}):this.onEventNotify({event_id:i,event_content:{detail:t}}))},GizwitsJS.prototype._getWebsocketConnInfo=function(e){var i="ws://",t=e.host,n=e.ws_port+""
return e.wss_port&&(i="wss://",n=e.wss_port+""),i+t+":"+n},GizwitsJS.prototype._getMQTTLenArray=function(e){var i=0,t=e,n=new Array
if(e<=0)return n
do{n[i++]=t/128>>0?t%128|128:t%128,t=t/128>>0}while(t)
return n},GizwitsJS.prototype._processSubdevicesReport=function(e,i){this._subDevices[e]={}
var t=0,n=new Uint8Array(i.length)
n.set(i,0)
var s=new DataView(n.buffer),d=s.getUint16(t)
t+=2
for(var o=0;o<d;++o){var r=i.bin2string(t,LEN_PRODUCT_KEY)
t+=LEN_PRODUCT_KEY
var _=s.getUint16(t)
t+=2
for(var a=0;a<_;++a){var c={}
c.subDid=s.getUint32(t),t+=4,c.is_online=!!i[t++]
var D=i[t++]
c.mac=i.bin2string(t,D),t+=D,c.did=i.bin2string(t,LEN_DID),t+=LEN_DID,c.product_key=r,this._subDevices[e][c.did]=c}}},GizwitsJS.prototype._processSubdeviceOnlineReport=function(e,i){var t=0,n=new Uint8Array(i.length)
n.set(i,0)
var s=new DataView(n.buffer),d=s.getUint32(t)
t+=4
for(var o in this._subDevices[e])if(this._subDevices[e][o].subDid===d){this._subDevices[e][o].is_online=!!i[t]
break}},GizwitsJS.prototype._onUpdateSubDevices=function(e){if(this.onUpdateSubDevices){var i=0,t=[]
for(var n in this._subDevices[e])t[i++]={did:this._subDevices[e][n].did,mac:this._subDevices[e][n].mac,is_online:this._subDevices[e][n].is_online,product_key:this._subDevices[e][n].product_key}
this.onUpdateSubDevices({did:e,subDevices:t}),this._getBoundDevices(GET_BOUND_DEV_ONE_STEP_LIMIT,0)}},Array.prototype.bin2string=function(e,i){for(var t="",n=0;n<i&&this[e+n];n++)t+=String.fromCharCode(this[e+n])
return t},String.prototype.format=function(){var e=arguments
return this.replace(/\{(\d+)\}/g,function(i,t){return e[t]})}
