/**
 * @fileOverview  Gizwits JavaScript SDK
 * @version 0.1.0
 * @author Trevor(trevortao@gizwits.com)
 */
function GizwitsJS(e){return e?e.apiHost?e.gizwitsOpenId?e.gizwitsAppId?(this.onBindDevice=void 0,this.onEventNotify=void 0,this.onReceiveData=void 0,this.onUnBindDevice=void 0,this.onSetDeviceInfo=void 0,this.onGetDeviceList=void 0,this.onDiscoverDevices=void 0,this.onSubscribeDevice=void 0,this.onUpdateSubDevices=void 0,this.onDeviceOnlineStatusChanged=void 0,this.onGetGroupList=void 0,this.onUpdateGroupList=void 0,this.onEditGroupName=void 0,this.onUpdateGroupDeviceList=void 0,this.onGroupWrite=void 0,this.onGetSceneList=void 0,this.onEditSceneInfo=void 0,this.onUpdateSceneList=void 0,this.onUpdateSceneStatus=void 0,this.onExecuteScene=void 0,this.onGetBindingUsers=void 0,this.onUnbindUser=void 0,this.onGetDeviceSharingInfos=void 0,this.onSharingDevice=void 0,this.onRevokeDeviceSharing=void 0,this.onAcceptDeviceSharing=void 0,this.onCheckDeviceSharingInfoByQRCode=void 0,this.onAcceptDeviceSharingByQRCode=void 0,this.onModifySharingInfo=void 0,this.onQueryMessageList=void 0,this.onMarkMessageStatus=void 0,this._gloabSN=1,this._keepalive=180,this._subDevices={},this._connections={},this._boundDevices={},this._userID=void 0,this._userToken=void 0,this._heartbeatInterval=55,this._apiHost=e.apiHost,this._appID=e.gizwitsAppId,this._openID=e.gizwitsOpenId,this._groupList={},void(this._sceneList={})):void console.log("Call GizwitsJS with invaild params.gizwitsAppId "+e.gizwitsAppId):void console.log("Call GizwitsJS with invaild params.gizwitsOpenId "+e.gizwitsOpenId):void console.log("Call GizwitsJS with invaild params.apiHost "+e.apiHost):void console.log("Call GizwitsJS with invaild params "+e)}function Connection(e,i){this._subscribedDids={},this._loginFailedCount=0,this._websocket=void 0,this._callbackObj=i,this._heartbeatTimerID=void 0,this._lastConnectMilliTimestamp=0,this._wsUrl="{0}/ws/app/v1".format(e)}function hexMD5(e){return binl2hex(coreMD5(str2binl(e),e.length*CHAR_SIZE))}function coreMD5(e,i){e[i>>5]|=128<<i%32,e[14+(i+64>>>9<<4)]=i
for(var t=1732584193,n=-271733879,s=-1732584194,o=271733878,r=0;r<e.length;r+=16){var a=t,d=n,_=s,c=o
t=md5FF(t,n,s,o,e[r+0],7,-680876936),o=md5FF(o,t,n,s,e[r+1],12,-389564586),s=md5FF(s,o,t,n,e[r+2],17,606105819),n=md5FF(n,s,o,t,e[r+3],22,-1044525330),t=md5FF(t,n,s,o,e[r+4],7,-176418897),o=md5FF(o,t,n,s,e[r+5],12,1200080426),s=md5FF(s,o,t,n,e[r+6],17,-1473231341),n=md5FF(n,s,o,t,e[r+7],22,-45705983),t=md5FF(t,n,s,o,e[r+8],7,1770035416),o=md5FF(o,t,n,s,e[r+9],12,-1958414417),s=md5FF(s,o,t,n,e[r+10],17,-42063),n=md5FF(n,s,o,t,e[r+11],22,-1990404162),t=md5FF(t,n,s,o,e[r+12],7,1804603682),o=md5FF(o,t,n,s,e[r+13],12,-40341101),s=md5FF(s,o,t,n,e[r+14],17,-1502002290),n=md5FF(n,s,o,t,e[r+15],22,1236535329),t=md5GG(t,n,s,o,e[r+1],5,-165796510),o=md5GG(o,t,n,s,e[r+6],9,-1069501632),s=md5GG(s,o,t,n,e[r+11],14,643717713),n=md5GG(n,s,o,t,e[r+0],20,-373897302),t=md5GG(t,n,s,o,e[r+5],5,-701558691),o=md5GG(o,t,n,s,e[r+10],9,38016083),s=md5GG(s,o,t,n,e[r+15],14,-660478335),n=md5GG(n,s,o,t,e[r+4],20,-405537848),t=md5GG(t,n,s,o,e[r+9],5,568446438),o=md5GG(o,t,n,s,e[r+14],9,-1019803690),s=md5GG(s,o,t,n,e[r+3],14,-187363961),n=md5GG(n,s,o,t,e[r+8],20,1163531501),t=md5GG(t,n,s,o,e[r+13],5,-1444681467),o=md5GG(o,t,n,s,e[r+2],9,-51403784),s=md5GG(s,o,t,n,e[r+7],14,1735328473),n=md5GG(n,s,o,t,e[r+12],20,-1926607734),t=md5HH(t,n,s,o,e[r+5],4,-378558),o=md5HH(o,t,n,s,e[r+8],11,-2022574463),s=md5HH(s,o,t,n,e[r+11],16,1839030562),n=md5HH(n,s,o,t,e[r+14],23,-35309556),t=md5HH(t,n,s,o,e[r+1],4,-1530992060),o=md5HH(o,t,n,s,e[r+4],11,1272893353),s=md5HH(s,o,t,n,e[r+7],16,-155497632),n=md5HH(n,s,o,t,e[r+10],23,-1094730640),t=md5HH(t,n,s,o,e[r+13],4,681279174),o=md5HH(o,t,n,s,e[r+0],11,-358537222),s=md5HH(s,o,t,n,e[r+3],16,-722521979),n=md5HH(n,s,o,t,e[r+6],23,76029189),t=md5HH(t,n,s,o,e[r+9],4,-640364487),o=md5HH(o,t,n,s,e[r+12],11,-421815835),s=md5HH(s,o,t,n,e[r+15],16,530742520),n=md5HH(n,s,o,t,e[r+2],23,-995338651),t=md5II(t,n,s,o,e[r+0],6,-198630844),o=md5II(o,t,n,s,e[r+7],10,1126891415),s=md5II(s,o,t,n,e[r+14],15,-1416354905),n=md5II(n,s,o,t,e[r+5],21,-57434055),t=md5II(t,n,s,o,e[r+12],6,1700485571),o=md5II(o,t,n,s,e[r+3],10,-1894986606),s=md5II(s,o,t,n,e[r+10],15,-1051523),n=md5II(n,s,o,t,e[r+1],21,-2054922799),t=md5II(t,n,s,o,e[r+8],6,1873313359),o=md5II(o,t,n,s,e[r+15],10,-30611744),s=md5II(s,o,t,n,e[r+6],15,-1560198380),n=md5II(n,s,o,t,e[r+13],21,1309151649),t=md5II(t,n,s,o,e[r+4],6,-145523070),o=md5II(o,t,n,s,e[r+11],10,-1120210379),s=md5II(s,o,t,n,e[r+2],15,718787259),n=md5II(n,s,o,t,e[r+9],21,-343485551),t=safeAdd(t,a),n=safeAdd(n,d),s=safeAdd(s,_),o=safeAdd(o,c)}return Array(t,n,s,o)}function md5CMN(e,i,t,n,s,o){return safeAdd(bitRol(safeAdd(safeAdd(i,e),safeAdd(n,o)),s),t)}function md5FF(e,i,t,n,s,o,r){return md5CMN(i&t|~i&n,e,i,s,o,r)}function md5GG(e,i,t,n,s,o,r){return md5CMN(i&n|t&~n,e,i,s,o,r)}function md5HH(e,i,t,n,s,o,r){return md5CMN(i^t^n,e,i,s,o,r)}function md5II(e,i,t,n,s,o,r){return md5CMN(t^(i|~n),e,i,s,o,r)}function safeAdd(e,i){var t=(65535&e)+(65535&i)
return(e>>16)+(i>>16)+(t>>16)<<16|65535&t}function bitRol(e,i){return e<<i|e>>>32-i}function str2binl(e){for(var i=Array(),t=(1<<CHAR_SIZE)-1,n=0;n<e.length*CHAR_SIZE;n+=CHAR_SIZE)i[n>>5]|=(e.charCodeAt(n/CHAR_SIZE)&t)<<n%32
return i}function binl2hex(e){for(var i="",t="0123456789abcdef",n=0;n<4*e.length;n++)i+=t.charAt(e[n>>2]>>n%4*8+4&15)+t.charAt(e[n>>2]>>n%4*8&15)
return i}var LEN_DID=22,CHAR_SIZE=8,LEN_PRODUCT_KEY=32,P0_TYPE_ATTRS_V4="attrs_v4",PROTOCOL_VER=[0,0,0,3],RETRY_WAIT_TIME=5e3,RETRY_SEND_TIME=2e3,GET_BOUND_DEV_ONE_STEP_LIMIT=20,DEV_TYPE_NORMAL="normal",DEV_TYPE_CENTER_CONTROL="center_control",DEV_TYPE_SUB="sub_dev",DEV_ROLE_SPECIAL="special",DEV_ROLE_OWNER="owner",DEV_ROLE_GUEST="guest",DEV_ROLE_NORMAL="normal",CMD_TRANS_BUSINESS_RESP=148,P0_CMD_REPORT_SUBDEVICE_STATUS=16,P0_CMD_ADD_SUBDEVICE_RESP=87,P0_CMD_DELETE_SUBDEVICE_RESP=89,P0_CMD_GET_SUBDEVICE_LIST_RESP=91,P0_CMD_REPORT_SUBDEVICE_LIST=92,ERROR_CODE={GIZ_SDK_PARAM_INVALID:8006,GIZ_SDK_DEVICE_DID_INVALID:8024,GIZ_SDK_DEVICE_NOT_CENTERCONTROL:8028,GIZ_SDK_DEVICE_NOT_BIND:8032,GIZ_SDK_BIND_DEVICE_FAILED:8039,GIZ_SDK_UNBIND_DEVICE_FAILED:8040,GIZ_SDK_HTTP_REQUEST_FAILED:8099,GIZ_SDK_SUBDEVICE_ADD_FAILED:8140,GIZ_SDK_WEB_SOCKET_CLOSED:8900,GIZ_SDK_SUBSCRIBE_FAILED:8901,GIZ_SDK_WEB_SOCKET_INVALID:8902,GIZ_SDK_WEB_SOCKET_ERROR:8903,GIZ_SDK_SET_DEVICE_INFO_ERROR:8904}
GizwitsJS.prototype.discoverDevices=function(){this._getUserToken()},GizwitsJS.prototype.getDeviceList=function(){this._onDiscoverDevices(this.onGetDeviceList)},GizwitsJS.prototype.subscribeDevice=function(e){if(!e)return void this._sendError(this.onSubscribeDevice,ERROR_CODE.GIZ_SDK_PARAM_INVALID,arguments.callee.name+": invaild params "+e)
if(!e.did)return void this._sendError(this.onSubscribeDevice,ERROR_CODE.GIZ_SDK_PARAM_INVALID,arguments.callee.name+": invaild params.did "+e.did)
if(!this._boundDevices)return void this._sendError(this.onSubscribeDevice,GIZ_SDK_DEVICE_NOT_BIND,arguments.callee.name+": "+e.did+" not exist in bound devices")
var i=this._boundDevices[e.did]
if(!i)return void this._sendError(this.onSubscribeDevice,ERROR_CODE.GIZ_SDK_DEVICE_NOT_BIND,arguments.callee.name+": "+e.did+" not exist in bound devices")
this._connect(i)},GizwitsJS.prototype.read=function(e){if(!e)return void this._sendError(this.onReceiveData,ERROR_CODE.GIZ_SDK_PARAM_INVALID,arguments.callee.name+": invaild params "+e)
if(!e.did)return void this._sendError(this.onReceiveData,ERROR_CODE.GIZ_SDK_PARAM_INVALID,arguments.callee.name+": invaild params.did "+e.did)
if(!this._boundDevices)return void this._sendError(this.onReceiveData,ERROR_CODE.GIZ_SDK_DEVICE_NOT_BIND,arguments.callee.name+": "+e.did+" not exist in bound devices")
var i=this._boundDevices[e.did]
if(!i)return void this._sendError(this.onReceiveData,ERROR_CODE.GIZ_SDK_DEVICE_NOT_BIND,arguments.callee.name+": "+e.did+" not exist in bound devices")
DEV_TYPE_CENTER_CONTROL===i.type&&i.is_online?this._getDeviceLatestData(i.did):e.attrs?this._sendJson(i,{cmd:"c2s_read",data:{did:e.did,names:e.attrs}}):this._sendJson(i,{cmd:"c2s_read",data:{did:e.did}})},GizwitsJS.prototype.write=function(e){if(!e)return void this._sendError(this.onReceiveData,ERROR_CODE.GIZ_SDK_PARAM_INVALID,arguments.callee.name+": invaild params "+e)
if(!e.did)return void this._sendError(this.onReceiveData,ERROR_CODE.GIZ_SDK_PARAM_INVALID,arguments.callee.name+": invaild params.did "+e.did)
if(!this._boundDevices)return void this._sendError(this.onReceiveData,ERROR_CODE.GIZ_SDK_DEVICE_NOT_BIND,arguments.callee.name+": "+e.did+" not exist in bound devices")
var i=this._boundDevices[e.did]
if(!i)return void this._sendError(this.onReceiveData,ERROR_CODE.GIZ_SDK_DEVICE_NOT_BIND,arguments.callee.name+": "+e.did+" not exist in bound devices")
e.attrs&&this._sendJson(i,{cmd:"c2s_write",data:{did:e.did,attrs:e.attrs}}),e.raw&&this._sendJson(i,{cmd:"c2s_raw",data:{did:e.did,raw:e.raw}})},GizwitsJS.prototype.updateSubDevices=function(e){if(!e)return void this._sendError(this.onUpdateSubDevices,ERROR_CODE.GIZ_SDK_PARAM_INVALID,arguments.callee.name+": invaild params "+e)
if(!e.did)return void this._sendError(this.onUpdateSubDevices,ERROR_CODE.GIZ_SDK_PARAM_INVALID,arguments.callee.name+": invaild params.did "+e.did)
if(this._boundDevices,!1)return void this._sendError(this.onUpdateSubDevices,ERROR_CODE.GIZ_SDK_DEVICE_NOT_BIND,arguments.callee.name+": "+e.did+" not exist in bound devices")
var i=this._boundDevices[e.did]
if(!i)return void this._sendError(this.onUpdateSubDevices,ERROR_CODE.GIZ_SDK_DEVICE_NOT_BIND,arguments.callee.name+": "+e.did+" not exist in bound devices")
if(i.type!=DEV_TYPE_CENTER_CONTROL)return void this._sendError(this.onUpdateSubDevices,ERROR_CODE.GIZ_SDK_DEVICE_NOT_CENTERCONTROL,arguments.callee.name+": is not center control device",e.did)
var t=0,n=new Uint8Array(8),s=new DataView(n.buffer)
n[t++]=0,n.set([0,147],t),t+=2,s.setInt32(t,this._gloabSN++),t+=4,n[t++]=90
var o=PROTOCOL_VER.concat(this._getMQTTLenArray(t)).concat(Array.from(n.slice(0,t)))
this._sendJson(i,{cmd:"c2s_raw",data:{did:e.did,raw:o}})},GizwitsJS.prototype.addSubDevice=function(e){if(!e)return void this._sendError(this.onUpdateSubDevices,ERROR_CODE.GIZ_SDK_PARAM_INVALID,arguments.callee.name+": invaild params "+e)
if(!e.did)return void this._sendError(this.onUpdateSubDevices,ERROR_CODE.GIZ_SDK_PARAM_INVALID,arguments.callee.name+": invaild params.did "+e.did)
if(!this._boundDevices)return void this._sendError(this.onUpdateSubDevices,ERROR_CODE.GIZ_SDK_DEVICE_NOT_BIND,arguments.callee.name+": "+e.did+" not exist in bound devices")
var i=this._boundDevices[e.did]
if(!i)return void this._sendError(this.onUpdateSubDevices,ERROR_CODE.GIZ_SDK_DEVICE_NOT_BIND,arguments.callee.name+": "+e.did+" not exist in bound devices")
if(i.type!=DEV_TYPE_CENTER_CONTROL)return void this._sendError(this.onUpdateSubDevices,ERROR_CODE.GIZ_SDK_DEVICE_NOT_CENTERCONTROL,arguments.callee.name+": is not center control device",e.did)
var t=0,n=new Uint8Array(128),s=new DataView(n.buffer)
n[t++]=0,n.set([0,147],t),t+=2,s.setInt32(t,this._gloabSN++),t+=4,n[t++]=86
var o=e.subDevices?e.subDevices.length:0
o&&(s.setInt16(t,o),t+=2)
for(var r=new TextEncoder,a=0;a<o;a++){var d=e.subDevices[a].mac
d&&(n[t++]=d.length,n.set(r.encode(d),t),t+=d.length)}var _=PROTOCOL_VER.concat(this._getMQTTLenArray(t)).concat(Array.from(n.slice(0,t)))
this._sendJson(i,{cmd:"c2s_raw",data:{did:e.did,raw:_}})},GizwitsJS.prototype.removeSubDevice=function(e){if(!e)return void this._sendError(this.onUpdateSubDevices,ERROR_CODE.GIZ_SDK_PARAM_INVALID,arguments.callee.name+": invaild params "+e)
if(!e.did)return void this._sendError(this.onUpdateSubDevices,ERROR_CODE.GIZ_SDK_PARAM_INVALID,arguments.callee.name+": invaild params.did "+e.did)
if(!e.subDevices)return void this._sendError(this.onUpdateSubDevices,ERROR_CODE.GIZ_SDK_PARAM_INVALID,arguments.callee.name+": invaild params.subDevices "+e.subDevices,e.did)
if(!this._boundDevices)return void this._sendError(this.onUpdateSubDevices,ERROR_CODE.GIZ_SDK_DEVICE_NOT_BIND,arguments.callee.name+": "+e.did+" not exist in bound devices")
var i=this._boundDevices[e.did]
if(!i)return void this._sendError(this.onUpdateSubDevices,ERROR_CODE.GIZ_SDK_DEVICE_NOT_BIND,arguments.callee.name+": "+e.did+" not exist in bound devices")
if(i.type!=DEV_TYPE_CENTER_CONTROL)return void this._sendError(this.onUpdateSubDevices,ERROR_CODE.GIZ_SDK_DEVICE_NOT_CENTERCONTROL,arguments.callee.name+": is not center control device",e.did)
var t=this._subDevices[e.did]
if(!t)return void this._sendError(this.onUpdateSubDevices,ERROR_CODE.GIZ_SDK_DEVICE_DID_INVALID,arguments.callee.name+": invaild did",e.did)
for(var n=0;n<e.subDevices.length;n++){var s=t[e.subDevices[n].did]
if(s){var o=0,r=new Uint8Array(16),a=new DataView(r.buffer)
r[o++]=0,r.set([0,147],o),o+=2,a.setInt32(o,this._gloabSN++),o+=4,r[o++]=88,a.setInt32(o,s.subDid),o+=4
var d=PROTOCOL_VER.concat(this._getMQTTLenArray(o)).concat(Array.from(r.slice(0,o)))
this._sendJson(i,{cmd:"c2s_raw",data:{did:e.did,raw:d}})}}},GizwitsJS.prototype.bindDevice=function(e){return e?e.device?e.bindInfo?void(e.bindInfo.product_secret?this._bindDeviceByMAC(e.device.mac,e.device.productKey,e.bindInfo.product_secret):e.bindInfo.device_bind_url?this._bindDeviceCustom(e.device.mac,e.device.productKey,e.bindInfo.device_bind_url):this._sendError(this.onBindDevice,ERROR_CODE.GIZ_SDK_PARAM_INVALID,"Please special valid product_secret or device_bind_url in bindInfo when calling bindDevice.")):void this._sendError(this.onBindDevice,ERROR_CODE.GIZ_SDK_PARAM_INVALID,arguments.callee.name+": invaild params.bindInfo "+e.bindInfo):void this._sendError(this.onBindDevice,ERROR_CODE.GIZ_SDK_PARAM_INVALID,arguments.callee.name+": invaild params.device "+e.device):void this._sendError(this.onBindDevice,ERROR_CODE.GIZ_SDK_PARAM_INVALID,arguments.callee.name+": invaild params "+e)},GizwitsJS.prototype.unBindDevice=function(e){if(!e)return void this._sendError(this.onUnBindDevice,ERROR_CODE.GIZ_SDK_PARAM_INVALID,arguments.callee.name+": invaild params "+e)
if(!e.did)return void this._sendError(this.onUnBindDevice,ERROR_CODE.GIZ_SDK_PARAM_INVALID,arguments.callee.name+": invaild params.did "+e.did)
if(!this._boundDevices)return void this._sendError(this.onUnBindDevice,ERROR_CODE.GIZ_SDK_DEVICE_NOT_BIND,arguments.callee.name+": "+e.did+" not exist in bound devices")
var i=this._boundDevices[e.did]
if(!i)return void this._sendError(this.onUnBindDevice,ERROR_CODE.GIZ_SDK_DEVICE_NOT_BIND,arguments.callee.name+": "+e.did+" not exist in bound devices")
this._unBindDevice(i.did)},GizwitsJS.prototype.setDeviceInfo=function(e){return e?e.did?null==e.remark&&null==e.alias?void this._sendError(this.onSetDeviceInfo,ERROR_CODE.GIZ_SDK_PARAM_INVALID,arguments.callee.name+": invaild params.remark "+e.remark+" and params.alias "+e.alias):this._boundDevices[e.did]?void this._setDeviceInfo(e.did,e.alias,e.remark):void this._sendError(this.onSetDeviceInfo,ERROR_CODE.GIZ_SDK_DEVICE_NOT_BIND,arguments.callee.name+": "+e.did+" not exist in bound devices"):void this._sendError(this.onSetDeviceInfo,ERROR_CODE.GIZ_SDK_PARAM_INVALID,arguments.callee.name+": invaild params.did "+e.did):void this._sendError(this.onSetDeviceInfo,ERROR_CODE.GIZ_SDK_PARAM_INVALID,arguments.callee.name+": invaild params "+e)},GizwitsJS.prototype.getGroupList=function(){this.onGetGroupList({groups:this._groupList})},GizwitsJS.prototype.addGroup=function(e){this._addGroup(e.name,e.product_key)},GizwitsJS.prototype.deleteGroup=function(e){this._deleteGroup(e.group_id)},GizwitsJS.prototype.updateGroupList=function(){this._updateGroupList()},GizwitsJS.prototype.editGroupInfo=function(e){this._editGroupInfo(e.group_id,e.group_name)},GizwitsJS.prototype.addGroupDevices=function(e){this._addGroupDevices(e.group_id,e.devices)},GizwitsJS.prototype.deleteGroupDevices=function(e){this._deleteGroupDevices(e.group_id,e.devices)},GizwitsJS.prototype.updateGroupDevices=function(e){this._updateGroupDevices(e.group_id)},GizwitsJS.prototype.groupWrite=function(e){this._groupWrite(e.group_id,e.attrs,e.raw)},GizwitsJS.prototype.getScenenList=function(){this.onGetSceneList({scenes:this._sceneList})},GizwitsJS.prototype.addScene=function(e){this._addScene(e.name,e.remark,e.tasks)},GizwitsJS.prototype.editSceneInfo=function(e){this._editSceneInfo(e.scene_id,e.scene_name,e.remark,e.tasks)},GizwitsJS.prototype.deleteScene=function(e){this._deleteScene(e.scene_id)},GizwitsJS.prototype.updateScenes=function(){this._updateScenes()},GizwitsJS.prototype.updateSceneStatus=function(e){this._updateSceneStatus(e.scene_id)},GizwitsJS.prototype.executeScene=function(e){this._executeScene(e.scene_id)},GizwitsJS.prototype.getBindingUsers=function(e){this._getBindingUsers(e.did)},GizwitsJS.prototype.unbindUser=function(e){this._unbindUser(e.did,e.uid)},GizwitsJS.prototype.getDeviceSharingInfos=function(e){this._getDeviceSharingInfos(e.did,e.type)},GizwitsJS.prototype.sharingDevice=function(e){this._sharingDevice(e.did,e.type,e.uid,e.username,e.email,e.phone)},GizwitsJS.prototype.revokeDeviceSharing=function(e){this._revokeDeviceSharing(e.id)},GizwitsJS.prototype.acceptDeviceSharing=function(e){this._acceptDeviceSharing(e.id,e.accept)},GizwitsJS.prototype.checkDeviceSharingInfoByQRCode=function(e){this._checkDeviceSharingInfoByQRCode(e.code)},GizwitsJS.prototype.acceptDeviceSharingByQRCode=function(e){this._acceptDeviceSharingByQRCode(e.code)},GizwitsJS.prototype.modifySharingInfo=function(e){this._modifySharingInfo(e.id,e.user_alias)},GizwitsJS.prototype.queryMessageList=function(e){this._queryMessageList(e.type)},GizwitsJS.prototype.markMessageStatus=function(e){this._markMessageStatus(e.id,e.status)},GizwitsJS.prototype._getDeviceLatestData=function(e){var i=this,t="https://{0}/app/devdata/{1}/latest".format(i._apiHost,e)
$.ajax(t,{type:"GET",contentType:"application/json",headers:{"X-Gizwits-Application-Id":i._appID,"X-Gizwits-User-token":i._userToken},dataType:"json"}).done(function(t){t.did&&t.attr&&i.onReceiveData({did:e,attrs:t.attr})})},GizwitsJS.prototype._unBindDevice=function(e){var i=this,t="https://{0}/app/bindings".format(i._apiHost),n=JSON.stringify({devices:[{did:e}]})
$.ajax(t,{type:"DELETE",contentType:"application/json",headers:{"X-Gizwits-Application-Id":i._appID,"X-Gizwits-User-token":i._userToken},dataType:"json",data:n}).done(function(t){if(t.success&&t.success[0]){i.onUnBindDevice({did:e}),DEV_TYPE_CENTER_CONTROL===i._boundDevices[e].type&&i._subDevices[e]&&delete i._subDevices[e]
var n=i._boundDevices[e],s=i._connections[i._getWebsocketConnInfo(n)]
s&&s._subscribedDids[e]&&(s._websocket.close(),s._removeSubscribeDid(e)),delete i._boundDevices[e],i._onDiscoverDevices(i.onDiscoverDevices)}else i._sendError(i.onUnBindDevice,i._getErrorCode(t,ERROR_CODE.GIZ_SDK_UNBIND_DEVICE_FAILED),"unbindDevice failed: "+JSON.stringify(t))}).fail(function(t){i._sendError(i.onUnBindDevice,i._getErrorCode(t,ERROR_CODE.GIZ_SDK_UNBIND_DEVICE_FAILED),"unbind device error, status:"+t.status+", responseText:"+t.responseText,e)})},GizwitsJS.prototype._setDeviceInfo=function(e,i,t){var n=this,s=!1,o="https://{0}/app/bindings/{1}".format(n._apiHost,e),r={}
t&&(r.remark=t),i&&(r.dev_alias=i)
var a=JSON.stringify(r)
$.ajax(o,{type:"PUT",contentType:"application/json",headers:{"X-Gizwits-Application-Id":n._appID,"X-Gizwits-User-token":n._userToken},dataType:"json",data:a}).done(function(i){i.remark&&n._boundDevices[e].remark!=i.remark&&(n._boundDevices[e].remark=i.remark,s=!0),i.dev_alias&&n._boundDevices[e].dev_alias!=i.dev_alias&&(n._boundDevices[e].dev_alias=i.dev_alias,s=!0),n.onSetDeviceInfo&&n.onSetDeviceInfo({did:e}),s&&n._onDiscoverDevices(n.onDiscoverDevices)}).fail(function(i){n._sendError(n.onSetDeviceInfo,n._getErrorCode(i,ERROR_CODE.GIZ_SDK_SET_DEVICE_INFO_ERROR),"set device info error, status:"+i.status+", responseText:"+i.responseText,e)})},GizwitsJS.prototype._bindDeviceByMAC=function(e,i,t){var n=this,s=Date.now()/1e3>>0,o=hexMD5(t+s),r="https://{0}/app/bind_mac".format(n._apiHost),a=JSON.stringify({mac:e,product_key:i})
$.ajax(r,{type:"POST",contentType:"application/json",headers:{"X-Gizwits-Application-Id":n._appID,"X-Gizwits-User-token":n._userToken,"X-Gizwits-Timestamp":s,"X-Gizwits-Signature":o},dataType:"json",data:a}).done(function(e){e.did?(n._boundDevices[e.did]=e,n.onBindDevice&&n.onBindDevice({did:e.did}),n._onDiscoverDevices(n.onDiscoverDevices)):n._sendError(n.onBindDevice,n._getErrorCode(e,ERROR_CODE.GIZ_SDK_BIND_DEVICE_FAILED),"bindDevice response invaild result: "+JSON.stringify(e))}).fail(function(e){n._sendError(n.onBindDevice,n._getErrorCode(e,ERROR_CODE.GIZ_SDK_BIND_DEVICE_FAILED),"bindDevice error, status:"+e.status+", responseText:"+e.responseText)})},GizwitsJS.prototype._bindDeviceCustom=function(e,i,t){var n=this,s=JSON.stringify({mac:e,token:n._userToken,product_key:i})
$.ajax(t,{type:"POST",contentType:"application/json",dataType:"json",data:s}).done(function(e){if(e.host)n._boundDevices[e.did]=e,n.onBindDevice&&n.onBindDevice({did:e.did}),n._onDiscoverDevices(n.onDiscoverDevices)
else{var i=!1
"online"===e.netStatus&&(i=!0),e.did?(n._boundDevices[e.did]={remark:"",dev_alias:"",type:"sub_dev",did:e.did,mac:e.mac,is_online:i,product_key:e.product_key},n.onBindDevice&&n.onBindDevice({did:e.did}),n._getBoundDevices(GET_BOUND_DEV_ONE_STEP_LIMIT,0)):n._sendError(n.onBindDevice,n._getErrorCode(e,ERROR_CODE.GIZ_SDK_BIND_DEVICE_FAILED),"bindDevice response invaild result: "+JSON.stringify(e))}}).fail(function(e){n._sendError(n.onBindDevice,n._getErrorCode(e,ERROR_CODE.GIZ_SDK_BIND_DEVICE_FAILED),"bindDevice error, status:"+e.status+", responseText:"+e.responseText)})},GizwitsJS.prototype._getUserToken=function(){var e=this,i="https://{0}/app/users".format(e._apiHost),t=JSON.stringify({phone_id:e._openID,lang:"en"})
$.ajax(i,{type:"POST",contentType:"application/json",headers:{"X-Gizwits-Application-Id":e._appID},dataType:"json",data:t}).done(function(i){e._userID=i.uid,e._userToken=i.token,e._updateGroupList(),e._updateScenes(),e._getBoundDevices(GET_BOUND_DEV_ONE_STEP_LIMIT,0)}).fail(function(i){e._sendError(e.onDiscoverDevices,e._getErrorCode(i,ERROR_CODE.GIZ_SDK_HTTP_REQUEST_FAILED),"get user token failed, status:"+i.status+", responseText:"+i.responseText)})},GizwitsJS.prototype._getBoundDevices=function(e,i){var t=this,n="https://{0}/app/bindings".format(t._apiHost),s="?show_disabled=0&limit="+e+"&skip="+i
$.ajax(n+s,{type:"GET",contentType:"application/json",dataType:"json",headers:{"X-Gizwits-Application-Id":t._appID,"X-Gizwits-User-token":t._userToken}}).done(function(n){0===i&&(t._boundDevices={})
for(var s=n.devices.length-1;s>=0;s--){var o=n.devices[s]
t._boundDevices[o.did]=o}n.devices.length===e?t._getBoundDevices(e,i+e):t._onDiscoverDevices(t.onDiscoverDevices)}).fail(function(e){t._boundDevices={},t._sendError(t.onDiscoverDevices,t._getErrorCode(e,ERROR_CODE.GIZ_SDK_HTTP_REQUEST_FAILED),"getBoundDevices error, status:"+e.status+", responseText:"+e.responseText)})},GizwitsJS.prototype._updateGroupList=function(){var e=this,i="https://{0}/app/group".format(e._apiHost)
$.ajax(i,{type:"GET",contentType:"application/json",headers:{"X-Gizwits-Application-Id":e._appID,"X-Gizwits-User-token":e._userToken},dataType:"json"}).done(function(i){if(e._groupList=new Array,i)for(var t=0;t<i.length;t++){var n=i[t]
e._groupList[t]={group_id:n.id,group_name:n.group_name,group_product_key:n.product_key,verbose_name:n.verbose_name}}e.onUpdateGroupList({groups:e._groupList},null)}).fail(function(i){e._groupList={},e._sendError(e.onUpdateGroupList,e._getErrorCode(i,ERROR_CODE.GIZ_SDK_HTTP_REQUEST_FAILED),"onUpdateGroupList error, status:"+i.status+", responseText:"+i.responseText)})},GizwitsJS.prototype._addGroup=function(e,i){var t=this,n="https://{0}/app/group".format(t._apiHost),s=JSON.stringify({product_key:i,group_name:e})
$.ajax(n,{type:"POST",contentType:"application/json",headers:{"X-Gizwits-Application-Id":t._appID,"X-Gizwits-User-token":t._userToken},dataType:"json",data:s}).done(function(e){t._updateGroupList()}).fail(function(e){t._sendError(t.onUpdateGroupList,t._getErrorCode(e,ERROR_CODE.GIZ_SDK_HTTP_REQUEST_FAILED),"onUpdateGroupList error, status:"+e.status+", responseText:"+e.responseText)})},GizwitsJS.prototype._deleteGroup=function(e){var i=this,t="https://{0}/app/group/{1}".format(i._apiHost,e)
$.ajax(t,{type:"DELETE",contentType:"application/json",headers:{"X-Gizwits-Application-Id":i._appID,"X-Gizwits-User-token":i._userToken},dataType:"json"}).done(function(e){i._updateGroupList()}).fail(function(e){200==e.status?i._updateGroupList():i._sendError(i.onUpdateGroupList,i._getErrorCode(e,ERROR_CODE.GIZ_SDK_HTTP_REQUEST_FAILED),"onUpdateGroupList error, status:"+e.status+", responseText:"+e.responseText)})},GizwitsJS.prototype._editGroupInfo=function(e,i){var t=this,n="https://{0}/app/group/{1}".format(t._apiHost,e),s=JSON.stringify({group_name:i})
$.ajax(n,{type:"PUT",contentType:"application/json",headers:{"X-Gizwits-Application-Id":t._appID,"X-Gizwits-User-token":t._userToken},dataType:"json",data:s}).done(function(i){t.onEditGroupName({group_id:e},null)}).fail(function(i){200==i.status?t.onEditGroupName({group_id:e},null):t.onEditGroupName(null,{group_id:e,error_code:t._getErrorCode(i,ERROR_CODE.GIZ_SDK_HTTP_REQUEST_FAILED),error_message:"onEditGroupName error, status:"+i.status,detail_message:"responseText:"+i.responseText})})},GizwitsJS.prototype._addGroupDevices=function(e,i){var t=this,n="https://{0}/app/group/{1}/devices".format(t._apiHost,e),s=JSON.stringify({dids:i})
$.ajax(n,{type:"POST",contentType:"application/json",headers:{"X-Gizwits-Application-Id":t._appID,"X-Gizwits-User-token":t._userToken},dataType:"json",data:s}).done(function(i){console.log("result = "+JSON.stringify(i)),i.success.length>0?t._updateGroupDevices(e):t.onUpdateGroupDeviceList(null,{group_id:e,error_code:t._getErrorCode(i,ERROR_CODE.GIZ_SDK_HTTP_REQUEST_FAILED),error_message:i.failed,detail_message:i.detail_message})}).fail(function(i){t.onUpdateGroupDeviceList(null,{group_id:e,error_code:t._getErrorCode(i,ERROR_CODE.GIZ_SDK_HTTP_REQUEST_FAILED),error_message:"onUpdateGroupDeviceList error, status:"+i.status,detail_message:"responseText:"+i.responseText})})},GizwitsJS.prototype._deleteGroupDevices=function(e,i){var t=this,n="https://{0}/app/group/{1}/devices".format(t._apiHost,e),s=JSON.stringify({dids:i})
$.ajax(n,{type:"DELETE",contentType:"application/json",headers:{"X-Gizwits-Application-Id":t._appID,"X-Gizwits-User-token":t._userToken},dataType:"json",data:s}).done(function(i){i.success.length>0?t._updateGroupDevices(e):t.onUpdateGroupDeviceList(null,{group_id:e,error_code:ERROR_CODE.GIZ_SDK_HTTP_REQUEST_FAILED,error_message:i.failed})}).fail(function(i){t.onUpdateGroupDeviceList(null,{group_id:e,error_code:t._getErrorCode(i,ERROR_CODE.GIZ_SDK_HTTP_REQUEST_FAILED),error_message:"onUpdateGroupDeviceList error, status:"+i.status,detail_message:"responseText:"+i.responseText})})},GizwitsJS.prototype._updateGroupDevices=function(e){var i=this,t="https://{0}/app/group/{1}/devices".format(i._apiHost,e)
$.ajax(t,{type:"GET",contentType:"application/json",headers:{"X-Gizwits-Application-Id":i._appID,"X-Gizwits-User-token":i._userToken},dataType:"json"}).done(function(t){var n=new Array
if(t)for(var s=0;s<t.length;s++){var o=t[s]
n[s]={did:o.did,type:o.type,product_key:o.product_key,verbose_name:o.verbose_name,dev_alias:o.dev_alias}}i.onUpdateGroupDeviceList({group_id:e,devices:n},null)}).fail(function(t){i.onUpdateGroupDeviceList(null,{group_id:e,error_code:i._getErrorCode(t,ERROR_CODE.GIZ_SDK_HTTP_REQUEST_FAILED),error_message:"onUpdateGroupDeviceList error, status:"+t.status,detail_message:"responseText:"+t.responseText})})},GizwitsJS.prototype._groupWrite=function(e,i,t){var n=this,s="https://{0}/app/group/{1}/control".format(n._apiHost,e),o=JSON.stringify({attrs:i,raw:t})
$.ajax(s,{type:"POST",contentType:"application/json",headers:{"X-Gizwits-Application-Id":n._appID,"X-Gizwits-User-token":n._userToken},dataType:"json",data:o}).done(function(i){i.length>0&&!0===i[0].result?n.onGroupWrite({group_id:e}):n.onGroupWrite(null,{group_id:e,error_code:ERROR_CODE.GIZ_SDK_HTTP_REQUEST_FAILED})}).fail(function(i){n.onGroupWrite(null,{group_id:e,error_code:n._getErrorCode(i,ERROR_CODE.GIZ_SDK_HTTP_REQUEST_FAILED),error_message:"onGroupWrite error, status:"+i.status,detail_message:"responseText:"+i.responseText})})},GizwitsJS.prototype._addScene=function(e,i,t){var n=this,s="https://{0}/app/scene".format(n._apiHost),o=JSON.stringify({scene_name:e,remark:i,tasks:t})
$.ajax(s,{type:"POST",contentType:"application/json",headers:{"X-Gizwits-Application-Id":n._appID,"X-Gizwits-User-token":n._userToken},dataType:"json",data:o}).done(function(e){n._updateScenes()}).fail(function(e){n._sendError(n.onUpdateSceneList,n._getErrorCode(e,ERROR_CODE.GIZ_SDK_HTTP_REQUEST_FAILED),"onUpdateSceneList error, status:"+e.status+", responseText:"+e.responseText)})},GizwitsJS.prototype._editSceneInfo=function(e,i,t,n){var s=this,o="https://{0}/app/scene/{1}".format(s._apiHost,e),r=JSON.stringify({scene_name:i,remark:t,tasks:n})
$.ajax(o,{type:"PUT",contentType:"application/json",headers:{"X-Gizwits-Application-Id":s._appID,"X-Gizwits-User-token":s._userToken},dataType:"json",data:r}).done(function(i){s.onEditSceneInfo({scene_id:e},null)}).fail(function(i){200==i.status?s.onEditSceneInfo({scene_id:e},null):s._sendError(s.onEditSceneInfo,s._getErrorCode(i,ERROR_CODE.GIZ_SDK_HTTP_REQUEST_FAILED),"onEditSceneInfo error, status:"+i.status+", responseText:"+i.responseText)})},GizwitsJS.prototype._deleteScene=function(e){var i=this,t="https://{0}/app/scene/{1}".format(i._apiHost,e)
$.ajax(t,{type:"DELETE",contentType:"application/json",headers:{"X-Gizwits-Application-Id":i._appID,"X-Gizwits-User-token":i._userToken},dataType:"json"}).done(function(e){i._updateScenes()}).fail(function(e){200==e.status?i._updateScenes():i._sendError(i.onUpdateSceneList,i._getErrorCode(e,ERROR_CODE.GIZ_SDK_HTTP_REQUEST_FAILED),"onUpdateSceneList error, status:"+e.status+", responseText:"+e.responseText)})},GizwitsJS.prototype._updateScenes=function(){var e=this,i="https://{0}/app/scene".format(e._apiHost)
$.ajax(i,{type:"GET",contentType:"application/json",headers:{"X-Gizwits-Application-Id":e._appID,"X-Gizwits-User-token":e._userToken},dataType:"json"}).done(function(i){if(e._sceneList=new Array,i){for(var t=0;t<i.length;t++){var n=i[t]
e._sceneList[t]={scene_id:n.id,scene_name:n.scene_name,tasks:n.tasks,remark:n.remark}}e.onUpdateSceneList({scenes:e._sceneList})}else e.onUpdateSceneList(null,{error_code:ERROR_CODE.GIZ_SDK_HTTP_REQUEST_FAILED})}).fail(function(i){e._sceneList=new Array,e._sendError(e.onUpdateSceneList,e._getErrorCode(i,ERROR_CODE.GIZ_SDK_HTTP_REQUEST_FAILED),"onUpdateSceneList error, status:"+i.status+", responseText:"+i.responseText)})},GizwitsJS.prototype._updateSceneStatus=function(e){var i=this,t="https://{0}/app/scene/{1}/task".format(i._apiHost,e)
$.ajax(t,{type:"GET",contentType:"application/json",headers:{"X-Gizwits-Application-Id":i._appID,"X-Gizwits-User-token":i._userToken},dataType:"json"}).done(function(t){t?i.onUpdateSceneStatus({scene_id:e,status:t.status}):i.onUpdateSceneStatus(null,{error_code:ERROR_CODE.GIZ_SDK_HTTP_REQUEST_FAILED})}).fail(function(e){i._sendError(i.onUpdateSceneStatus,i._getErrorCode(e,ERROR_CODE.GIZ_SDK_HTTP_REQUEST_FAILED),"onUpdateSceneStatus error, status:"+e.status+", responseText:"+e.responseText)})},GizwitsJS.prototype._executeScene=function(e){var i=this,t="https://{0}/app/scene/{1}/task".format(i._apiHost,e)
$.ajax(t,{type:"POST",contentType:"application/json",headers:{"X-Gizwits-Application-Id":i._appID,"X-Gizwits-User-token":i._userToken},dataType:"json"}).done(function(t){i.onExecuteScene({scene_id:e},null),i._updateSceneStatus(e)}).fail(function(t){200==t.status?(i.onExecuteScene({scene_id:e},null),i._updateSceneStatus(e)):i._sendError(i.onExecuteScene,i._getErrorCode(t,ERROR_CODE.GIZ_SDK_HTTP_REQUEST_FAILED),"onExecuteScene error, status:"+t.status+", responseText:"+t.responseText)})},GizwitsJS.prototype._getBindingUsers=function(e){var i=this,t="https://{0}/app/{1}/bindings".format(i._apiHost,e)
$.ajax(t,{type:"GET",contentType:"application/json",headers:{"X-Gizwits-Application-Id":i._appID,"X-Gizwits-User-token":i._userToken},dataType:"json"}).done(function(t){for(var n=new Array,s=0;s<t.length;s++){var o=t[s]
n[s]={uid:o.uid,username:o.username,email:o.email,phone:o.phone}}i.onGetBindingUsers({did:e,bindUsers:n},null)}).fail(function(e){i._sendError(i.onGetBindingUsers,i._getErrorCode(e,ERROR_CODE.GIZ_SDK_HTTP_REQUEST_FAILED),"onGetBindingUsers error, status:"+e.status+", responseText:"+e.responseText)})},GizwitsJS.prototype._unbindUser=function(e,i){var t=this,n="https://{0}/app/{1}/bindings?uid={2}".format(t._apiHost,e,i)
$.ajax(n,{type:"DELETE",contentType:"application/json",headers:{"X-Gizwits-Application-Id":t._appID,"X-Gizwits-User-token":t._userToken},dataType:"json"}).done(function(i){t.onUnbindUser({did:e},null)}).fail(function(i){200==i.status?t.onUnbindUser({did:e},null):t._sendError(t.onUnbindUser,t._getErrorCode(i,ERROR_CODE.GIZ_SDK_HTTP_REQUEST_FAILED),"onUnbindUser error, status:"+i.status+", responseText:"+i.responseText)})},GizwitsJS.prototype._getDeviceSharingInfos=function(e,i){var t=this,n=void 0
n=e?"https://{0}/app/sharing?did={1}&sharing_type={2}&limit=100&skip=0".format(t._apiHost,e,i):"https://{0}/app/sharing?sharing_type={1}".format(t._apiHost,i),$.ajax(n,{type:"GET",contentType:"application/json",headers:{"X-Gizwits-Application-Id":t._appID,"X-Gizwits-User-token":t._userToken},dataType:"json"}).done(function(i){for(var n=new Array,s=0;s<i.objects.length;s++){var o=i.objects[s]
n[s]={id:o.id,type:o.type,uid:o.uid,username:o.username,user_alias:o.user_alias,email:o.email,phone:o.phone,did:o.did,product_name:o.product_name,dev_alias:o.dev_alias,status:o.status}}t.onGetDeviceSharingInfos({did:e,sharing_list:n},null)}).fail(function(e){t._sendError(t.onGetDeviceSharingInfos,t._getErrorCode(e,ERROR_CODE.GIZ_SDK_HTTP_REQUEST_FAILED),"onGetDeviceSharingInfos error, status:"+e.status+", responseText:"+e.responseText)})},GizwitsJS.prototype._sharingDevice=function(e,i,t,n,s,o){var r=this,a="https://{0}/app/sharing".format(r._apiHost),d=JSON.stringify({type:i,did:e,uid:t,username:n,email:s,phone:o})
$.ajax(a,{type:"POST",contentType:"application/json",headers:{"X-Gizwits-Application-Id":r._appID,"X-Gizwits-User-token":r._userToken},dataType:"json",data:d}).done(function(e){r.onSharingDevice({id:e.id,qr_content:e.qr_content},null)}).fail(function(e){r._sendError(r.onSharingDevice,r._getErrorCode(e,ERROR_CODE.GIZ_SDK_HTTP_REQUEST_FAILED),"onSharingDevice error, status:"+e.status+", responseText:"+e.responseText)})},GizwitsJS.prototype._revokeDeviceSharing=function(e){var i=this,t="https://{0}/app/sharing/{1}".format(i._apiHost,e)
$.ajax(t,{type:"DELETE",contentType:"application/json",headers:{"X-Gizwits-Application-Id":i._appID,"X-Gizwits-User-token":i._userToken},dataType:"json"}).done(function(e){i.onRevokeDeviceSharing({id:e.id},null)}).fail(function(e){i._sendError(i.onRevokeDeviceSharing,i._getErrorCode(e,ERROR_CODE.GIZ_SDK_HTTP_REQUEST_FAILED),"onRevokeDeviceSharing error, status:"+e.status+", responseText:"+e.responseText)})},GizwitsJS.prototype._acceptDeviceSharing=function(e,i){var t=this,n="https://{0}/app/sharing/{1}?status={2}".format(t._apiHost,e,i)
$.ajax(n,{type:"PUT",contentType:"application/json",headers:{"X-Gizwits-Application-Id":t._appID,"X-Gizwits-User-token":t._userToken},dataType:"json"}).done(function(e){t.onAcceptDeviceSharing({id:e.id},null)}).fail(function(e){t._sendError(t.onAcceptDeviceSharing,t._getErrorCode(e,ERROR_CODE.GIZ_SDK_HTTP_REQUEST_FAILED),"onAcceptDeviceSharing error, status:"+e.status+", responseText:"+e.responseText)})},GizwitsJS.prototype._checkDeviceSharingInfoByQRCode=function(e){var i=this,t="https://{0}/app/sharing/code/{1}".format(i._apiHost,e)
$.ajax(t,{type:"GET",contentType:"application/json",headers:{"X-Gizwits-Application-Id":i._appID,"X-Gizwits-User-token":i._userToken},dataType:"json"}).done(function(e){i.onCheckDeviceSharingInfoByQRCode({owner:e.owner,product_name:e.product_name,dev_alias:e.dev_alias,expired_at:e.expired_at},null)}).fail(function(e){i._sendError(i.onCheckDeviceSharingInfoByQRCode,i._getErrorCode(e,ERROR_CODE.GIZ_SDK_HTTP_REQUEST_FAILED),"onCheckDeviceSharingInfoByQRCode error, status:"+e.status+", responseText:"+e.responseText)})},GizwitsJS.prototype._acceptDeviceSharingByQRCode=function(e){var i=this,t="https://{0}/app/sharing/code/{1}".format(i._apiHost,e)
$.ajax(t,{type:"POST",contentType:"application/json",headers:{"X-Gizwits-Application-Id":i._appID,"X-Gizwits-User-token":i._userToken},dataType:"json"}).done(function(e){i.onAcceptDeviceSharingByQRCode({error_code:0,error_message:"GIZ_SDK_SUCCESS"},null)}).fail(function(e){200==e.status?i.onAcceptDeviceSharingByQRCode({error_code:0,error_message:"GIZ_SDK_SUCCESS"},null):i._sendError(i.onAcceptDeviceSharingByQRCode,i._getErrorCode(e,ERROR_CODE.GIZ_SDK_HTTP_REQUEST_FAILED),"onAcceptDeviceSharingByQRCode error, status:"+e.status+", responseText:"+e.responseText)})},GizwitsJS.prototype._modifySharingInfo=function(e,i){var t=this,n="https://{0}/app/sharing/{1}/alias?user_alias={2}".format(t._apiHost,e,i)
$.ajax(n,{type:"PUT",contentType:"application/json",headers:{"X-Gizwits-Application-Id":t._appID,"X-Gizwits-User-token":t._userToken},dataType:"json"}).done(function(e){t.onModifySharingInfo({error_code:0,error_message:"GIZ_SDK_SUCCESS"},null)}).fail(function(e){200==e.status?t.onModifySharingInfo({error_code:0,error_message:"GIZ_SDK_SUCCESS"},null):t._sendError(t.onModifySharingInfo,t._getErrorCode(e,ERROR_CODE.GIZ_SDK_HTTP_REQUEST_FAILED),"onModifySharingInfo error, status:"+e.status+", responseText:"+e.responseText)})},GizwitsJS.prototype._queryMessageList=function(e){var i=this,t="https://{0}/app/messages?type={1}&skip=0&limit=100".format(i._apiHost,e)
$.ajax(t,{type:"GET",contentType:"application/json",headers:{"X-Gizwits-Application-Id":i._appID,"X-Gizwits-User-token":i._userToken},dataType:"json"}).done(function(e){for(var t=new Array,n=0;n<e.objects.length;n++){var s=e.objects[n]
t[n]={id:s.id,type:s.type,status:s.status,content:s.content,created_at:s.created_at,updated_at:s.updated_at}}i.onQueryMessageList({message_list:t},null)}).fail(function(e){i._sendError(i.onQueryMessageList,i._getErrorCode(e,ERROR_CODE.GIZ_SDK_HTTP_REQUEST_FAILED),"onQueryMessageList error, status:"+e.status+", responseText:"+e.responseText)})},GizwitsJS.prototype._markMessageStatus=function(e,i){var t=this,n="https://{0}/app/messages/{1}?status={2}".format(t._apiHost,e,i)
$.ajax(n,{type:"PUT",contentType:"application/json",headers:{"X-Gizwits-Application-Id":t._appID,"X-Gizwits-User-token":t._userToken},dataType:"json"}).done(function(e){t.onMarkMessageStatus({error_code:0,error_message:"GIZ_SDK_SUCCESS"},null)}).fail(function(e){200==e.status?t.onMarkMessageStatus({error_code:0,error_message:"GIZ_SDK_SUCCESS"},null):t._sendError(t.onMarkMessageStatus,t._getErrorCode(e,ERROR_CODE.GIZ_SDK_HTTP_REQUEST_FAILED),"onMarkMessageStatus error, status:"+e.status+", responseText:"+e.responseText)})},Connection.prototype._connectWS=function(){var e=this
e._stopPing()
var i=new WebSocket(e._wsUrl)
i.onopen=function(i){e._onWSOpen(i)},i.onclose=function(i){e._onWSClose(i)},i.onmessage=function(i){e._onWSMessage(i)},i.onerror=function(i){e._onWSError(i)},e._websocket=i},Connection.prototype._onWSOpen=function(e){this._login()},Connection.prototype._onWSClose=function(e){this._stopPing(),this._callbackObj._sendError(null,ERROR_CODE.GIZ_SDK_WEB_SOCKET_CLOSED,"Websocket Connect failed, please try again after a moment.")},Connection.prototype._onWSMessage=function(e){var i=JSON.parse(e.data)
switch(i.cmd){case"pong":break
case"login_res":!0===i.data.success?(this._loginFailedCount=0,this._startPing(),this._subscribeDevices()):this._tryLoginAgain()
break
case"subscribe_res":var t=i.data.failed,n=i.data.success
if(this._callbackObj.onSubscribeDevice)for(var s=n.length-1;s>=0;s--)this._callbackObj.onSubscribeDevice({did:n[s].did})
for(var o=t.length-1;o>=0;o--)this._removeSubscribeDid(t[o].did),this._callbackObj._sendError(this._callbackObj.onSubscribeDevice,ERROR_CODE.GIZ_SDK_SUBSCRIBE_FAILED,"subscribe device failed, please try again(Websocket error_code: "+t[o].error_code+", msg: "+t[o].msg+").",t[o].did)
break
case"s2c_online_status":var r=this._callbackObj._boundDevices[i.data.did]
if(r){if(r.is_online=i.data.online,this._callbackObj.onDeviceOnlineStatusChanged&&this._callbackObj.onDeviceOnlineStatusChanged({did:r.did,is_online:r.is_online}),DEV_TYPE_CENTER_CONTROL===r.type&&!r.is_online&&this._callbackObj._subDevices[r.did])for(var a in this._callbackObj._subDevices[r.did])if(!this._callbackObj._boundDevices[a]){var d=this._callbackObj._subDevices[r.did][a]
0!=d.is_online&&(d.is_online=!1,this._callbackObj.onDeviceOnlineStatusChanged&&this._callbackObj.onDeviceOnlineStatusChanged({did:d.did,is_online:d.is_online}),this._callbackObj._onUpdateSubDevices(r.did,!0))}this._callbackObj.onDiscoverDevices&&this._callbackObj._onDiscoverDevices(this._callbackObj.onDiscoverDevices)}break
case"s2c_raw":var _=void 0,c=[],p=i.data.did.substr(0,LEN_DID),r=this._callbackObj._boundDevices[p]
if(r){for(var u=0,s=4;s<i.data.raw.length&&128&i.data.raw[s];s++)++u
CMD_TRANS_BUSINESS_RESP===i.data.raw[7+u]?(_=i.data.raw[12+u],c=i.data.raw.slice(13+u)):(_=i.data.raw[8+u],c=i.data.raw.slice(9+u)),P0_CMD_REPORT_SUBDEVICE_STATUS===_?(this._callbackObj._processSubdeviceOnlineReport(p,c),this._callbackObj._onUpdateSubDevices(p,!0)):P0_CMD_GET_SUBDEVICE_LIST_RESP===_||P0_CMD_REPORT_SUBDEVICE_LIST===_?(this._callbackObj._processSubdevicesReport(p,c),this._callbackObj._onUpdateSubDevices(p,!0)):P0_CMD_ADD_SUBDEVICE_RESP===_?c[0]?this._callbackObj.onUpdateSubDevices&&this._callbackObj._sendError(this._callbackObj.onUpdateSubDevices,GIZ_SDK_SUBDEVICE_ADD_FAILED,"add subDevice for center control device failed",p):this._callbackObj._onUpdateSubDevices(p,!1):P0_CMD_DELETE_SUBDEVICE_RESP===_?c[0]?console.log("center control device "+p+" delete subDevice failed"):console.log("center control device "+p+" delete subDevice success"):this._callbackObj.onReceiveData&&this._callbackObj.onReceiveData({did:r.did,raw:i.data.raw})}break
case"s2c_noti":var r=this._callbackObj._boundDevices[i.data.did]
this._callbackObj.onReceiveData&&r&&this._callbackObj.onReceiveData({did:r.did,attrs:i.data.attrs})
break
case"s2c_invalid_msg":var D=i.data.error_code
1009===D?this._tryLoginAgain():this._callbackObj._sendError(null,ERROR_CODE.GIZ_SDK_WEB_SOCKET_INVALID,"ErrorCode "+D+": "+i.data.msg+", did = "+i.data.did)}},Connection.prototype._onWSError=function(e){this._callbackObj._sendError(null,ERROR_CODE.GIZ_SDK_WEB_SOCKET_ERROR,"Websocket on error")},Connection.prototype._startPing=function(){var e=this
if(!e._heartbeatTimerID){var i=1e3*e._callbackObj._heartbeatInterval
e._heartbeatTimerID=window.setInterval(function(){e._sendJson({cmd:"ping"})},i)}},Connection.prototype._stopPing=function(){this._heartbeatTimerID&&(window.clearInterval(this._heartbeatTimerID),this._heartbeatTimerID=null)},Connection.prototype._sendJson=function(e){var i=JSON.stringify(e),t=this._websocket
return t.OPEN===t.readyState?(t.send(i),!0):(console.log("["+Date()+"]Send data "+i+" error, websocket is not connected."),this._callbackObj._sendError(null,ERROR_CODE.GIZ_SDK_WEB_SOCKET_INVALID,"Websocket is not connected, please try to subscribe device again"),this._stopPing(),!1)},Connection.prototype._login=function(){var e=this._callbackObj._keepalive,i={cmd:"login_req",data:{appid:this._callbackObj._appID,uid:this._callbackObj._userID,token:this._callbackObj._userToken,p0_type:P0_TYPE_ATTRS_V4,heartbeat_interval:e,auto_subscribe:!1}}
this._sendJson(i)},Connection.prototype._tryLoginAgain=function(){var e=this
if(e._loginFailedCount+=1,e._loginFailedCount>3)return void e._websocket.close()
var i=e._loginFailedCount*RETRY_WAIT_TIME
window.setTimeout(function(){e._login()},i)},Connection.prototype._addSubscribeDid=function(e){this._subscribedDids[e]=e},Connection.prototype._removeSubscribeDid=function(e){delete this._subscribedDids[e]},Connection.prototype._subscribeDevice=function(e){var i={cmd:"subscribe_req",data:[{did:e}]}
this._sendJson(i)},Connection.prototype._subscribeDevices=function(){var e=[]
for(var i in this._subscribedDids)e.push({did:this._subscribedDids[i]})
var t={cmd:"subscribe_req",data:e}
this._sendJson(t)},GizwitsJS.prototype._onDiscoverDevices=function(e){if(e){var i=0,t=[]
for(var n in this._boundDevices){var s=this._boundDevices[n],o=this._connections[this._getWebsocketConnInfo(s)],r=!!o&&!!o._subscribedDids[s.did]
t[i++]={is_bind:!0,did:s.did,mac:s.mac,remark:s.remark,alias:s.dev_alias,is_subscribe:r,is_online:s.is_online,product_key:s.product_key,type:this._getDevTypeByStr(s.type),role:this._getDevRoleByStr(s.role)}}for(var n in this._subDevices)for(var a in this._subDevices[n])if(!this._boundDevices[a]){var s=this._subDevices[n][a]
t[i++]={is_bind:!1,did:s.did,mac:s.mac,remark:"",alias:"",is_subscribe:!1,is_online:s.is_online,product_key:s.product_key,type:this._getDevTypeByStr(DEV_TYPE_SUB),role:this._getDevRoleByStr(s.role)}}e({devices:t},null)}},GizwitsJS.prototype._getDevTypeByStr=function(e){return DEV_TYPE_CENTER_CONTROL===e?1:DEV_TYPE_SUB===e?2:0},GizwitsJS.prototype._getDevRoleByStr=function(e){return DEV_ROLE_SPECIAL===e?0:DEV_ROLE_OWNER===e?1:DEV_ROLE_GUEST===e?2:3},GizwitsJS.prototype._sendJson=function(e,i){var t=this._connections[this._getWebsocketConnInfo(e)]
if(!t)return void this._sendError(null,ERROR_CODE.GIZ_SDK_WEB_SOCKET_INVALID,"Websocket is not connected, please try to subscribe device again",e.did)
t._sendJson(i)||Date.now()-t._lastConnectMilliTimestamp>RETRY_WAIT_TIME&&(console.log("["+Date()+"]Send data error, try to connect again."),this._connect(e),t._lastConnectMilliTimestamp=Date.now(),window.setTimeout(function(){t._login()},RETRY_SEND_TIME))},GizwitsJS.prototype._connect=function(e){var i=this._getWebsocketConnInfo(e),t=this._connections[i]
t||(t=new Connection(i,this)),t._addSubscribeDid(e.did),t._connectWS(),this._connections[i]=t},GizwitsJS.prototype._getErrorCode=function(e,i){var t=i
if(e.responseText){var n=JSON.parse(e.responseText),s=n.error_code
s&&(t=s)}return t},GizwitsJS.prototype._sendError=function(e,i,t,n){e?n?e(null,{error_code:i,error_message:t,did:n}):e(null,{error_code:i,error_message:t}):this.onEventNotify&&(n?this.onEventNotify({event_id:i,event_content:{detail:t,did:n}}):this.onEventNotify({event_id:i,event_content:{detail:t}}))},GizwitsJS.prototype._getWebsocketConnInfo=function(e){var i="ws://",t=e.host,n=e.ws_port+""
return e.wss_port&&(i="wss://",n=e.wss_port+""),i+t+":"+n},GizwitsJS.prototype._getMQTTLenArray=function(e){var i=0,t=e,n=new Array
if(e<=0)return n
do{n[i++]=t/128>>0?t%128|128:t%128,t=t/128>>0}while(t)
return n},GizwitsJS.prototype._processSubdevicesReport=function(e,i){this._subDevices[e]={}
var t=0,n=new Uint8Array(i.length)
n.set(i,0)
var s=new DataView(n.buffer),o=s.getUint16(t)
t+=2
for(var r=0;r<o;++r){var a=i.bin2string(t,LEN_PRODUCT_KEY)
t+=LEN_PRODUCT_KEY
var d=s.getUint16(t)
t+=2
for(var _=0;_<d;++_){var c={}
c.subDid=s.getUint32(t),t+=4,c.is_online=!!i[t++]
var p=i[t++]
c.mac=i.bin2string(t,p),t+=p,c.did=i.bin2string(t,LEN_DID),t+=LEN_DID,c.product_key=a,this._subDevices[e][c.did]=c}}},GizwitsJS.prototype._processSubdeviceOnlineReport=function(e,i){var t=0,n=new Uint8Array(i.length)
n.set(i,0)
var s=new DataView(n.buffer),o=s.getUint32(t)
t+=4
for(var r in this._subDevices[e])if(this._subDevices[e][r].subDid===o){this._subDevices[e][r].is_online=!!i[t]
break}},GizwitsJS.prototype._onUpdateSubDevices=function(e,i){if(this.onUpdateSubDevices){var t=0,n=[]
for(var s in this._subDevices[e])n[t++]={did:this._subDevices[e][s].did,mac:this._subDevices[e][s].mac,is_online:this._subDevices[e][s].is_online,product_key:this._subDevices[e][s].product_key}
this.onUpdateSubDevices({did:e,subDevices:n}),i&&this._getBoundDevices(GET_BOUND_DEV_ONE_STEP_LIMIT,0)}},Array.prototype.bin2string=function(e,i){for(var t="",n=0;n<i&&this[e+n];n++)t+=String.fromCharCode(this[e+n])
return t},String.prototype.format=function(){var e=arguments
return this.replace(/\{(\d+)\}/g,function(i,t){return e[t]})}
